<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Biliardo.App.Pagine_Messaggi.Pagina_MessaggiDettaglio"
    x:Name="ThisPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Chat"
    BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=PageBgColor}">

    <Grid RowDefinitions="Auto,*,Auto,Auto"
          Padding="10"
          RowSpacing="8">

        <!-- HEADER -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*" ColumnSpacing="10"
              BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=TopBarBgColor}"
              Padding="6">

            <Button Text="â†"
                    WidthRequest="44"
                    HeightRequest="44"
                    BackgroundColor="#00000000"
                    TextColor="White"
                    Clicked="OnBackClicked" />

            <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                <Label Text="{Binding Source={x:Reference ThisPage}, Path=TitoloChat}"
                       TextColor="White"
                       FontAttributes="Bold"
                       FontSize="18"
                       LineBreakMode="TailTruncation" />
                <Label Text="{Binding Source={x:Reference ThisPage}, Path=DisplayNomeCompleto}"
                       IsVisible="{Binding Source={x:Reference ThisPage}, Path=HasDisplayNomeCompleto}"
                       TextColor="White"
                       FontSize="12"
                       Opacity="0.75"
                       LineBreakMode="TailTruncation" />
            </VerticalStackLayout>
        </Grid>

        <!-- AREA MESSAGGI + LOADING -->
        <Grid Grid.Row="1">
            <CollectionView x:Name="CvMessaggi"
                            ItemsSource="{Binding Source={x:Reference ThisPage}, Path=Messaggi}"
                            SelectionMode="None"
                            ItemsUpdatingScrollMode="KeepScrollOffset"
                            ItemSizingStrategy="{OnPlatform Android=MeasureAllItems, Default=MeasureFirstItem}"
                            Scrolled="OnMessagesScrolled">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="6" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="0,2">

                            <Border x:Name="DateSep"
                                    IsVisible="False"
                                    HorizontalOptions="Center"
                                    BackgroundColor="#1E1E1E"
                                    StrokeThickness="0"
                                    Padding="10,6">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>

                                <Label Text="{Binding DateSeparatorText}"
                                       TextColor="White"
                                       FontSize="12"
                                       Opacity="0.85" />

                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsDateSeparator}" Value="True">
                                        <Setter Property="IsVisible" Value="True" />
                                    </DataTrigger>
                                </Border.Triggers>
                            </Border>

                            <Border x:Name="Bubble"
                                    IsVisible="True"
                                    StrokeThickness="0"
                                    Padding="10"
                                    BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=BubblePeerColor}"
                                    HorizontalOptions="Start"
                                    MaximumWidthRequest="{Binding Source={x:Reference ThisPage}, Path=BubbleMaxWidth}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="14" />
                                </Border.StrokeShape>

                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsDateSeparator}" Value="True">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>

                                    <DataTrigger TargetType="Border" Binding="{Binding IsMine}" Value="True">
                                        <Setter Property="HorizontalOptions" Value="End" />
                                        <Setter Property="BackgroundColor" Value="{Binding Source={x:Reference ThisPage}, Path=BubbleMineColor}" />
                                    </DataTrigger>
                                </Border.Triggers>

                                <VerticalStackLayout Spacing="8">

                                    <Label Text="{Binding Text}"
                                           IsVisible="{Binding HasText}"
                                           TextColor="{Binding Source={x:Reference ThisPage}, Path=BubbleTextColor}"
                                           FontSize="14"
                                           LineBreakMode="WordWrap" />

                                    <Border IsVisible="{Binding IsPhoto}"
                                            StrokeThickness="0"
                                            Padding="0"
                                            BackgroundColor="#222222">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>

                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnPhotoTapped" />
                                        </Border.GestureRecognizers>

                                        <Image Source="{Binding MediaLocalPath}"
                                               HeightRequest="170"
                                               Aspect="AspectFill" />
                                    </Border>

                                    <Border IsVisible="{Binding IsFileOrVideo}"
                                            StrokeThickness="0"
                                            Padding="10"
                                            BackgroundColor="#1C1C1C">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>

                                        <VerticalStackLayout Spacing="6">
                                            <Label Text="{Binding FileLabel}"
                                                   TextColor="White"
                                                   FontAttributes="Bold"
                                                   LineBreakMode="TailTruncation" />
                                            <Button Text="Apri"
                                                    BackgroundColor="#2A2A2A"
                                                    TextColor="White"
                                                    Clicked="OnOpenMediaClicked"
                                                    CommandParameter="{Binding}" />
                                        </VerticalStackLayout>
                                    </Border>

                                    <Border IsVisible="{Binding IsAudio}"
                                            StrokeThickness="0"
                                            Padding="10"
                                            BackgroundColor="#1C1C1C">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>

                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                            <Button Text="{Binding AudioPlayStopLabel}"
                                                    BackgroundColor="#2A2A2A"
                                                    TextColor="White"
                                                    Clicked="OnPlayAudioClicked"
                                                    CommandParameter="{Binding}"
                                                    WidthRequest="90"
                                                    HeightRequest="40" />
                                            <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                <Label Text="{Binding AudioLabel}"
                                                       TextColor="White"
                                                       LineBreakMode="TailTruncation" />
                                                <Label Text="{Binding DurationLabel}"
                                                       TextColor="White"
                                                       FontSize="12"
                                                       Opacity="0.7" />
                                            </VerticalStackLayout>
                                        </Grid>
                                    </Border>

                                    <Border IsVisible="{Binding IsLocation}"
                                            StrokeThickness="0"
                                            Padding="10"
                                            BackgroundColor="#1C1C1C">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>
                                        <VerticalStackLayout Spacing="6">
                                            <Label Text="ðŸ“ Posizione"
                                                   TextColor="White"
                                                   FontAttributes="Bold" />
                                            <Label Text="{Binding LocationLabel}"
                                                   TextColor="White"
                                                   FontSize="12"
                                                   Opacity="0.7" />
                                            <Button Text="Apri su Mappe"
                                                    BackgroundColor="#2A2A2A"
                                                    TextColor="White"
                                                    Clicked="OnOpenLocationClicked"
                                                    CommandParameter="{Binding}" />
                                        </VerticalStackLayout>
                                    </Border>

                                    <Border IsVisible="{Binding IsContact}"
                                            StrokeThickness="0"
                                            Padding="10"
                                            BackgroundColor="#1C1C1C">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>
                                        <VerticalStackLayout Spacing="6">
                                            <Label Text="ðŸ‘¤ Contatto"
                                                   TextColor="White"
                                                   FontAttributes="Bold" />
                                            <Label Text="{Binding ContactLabel}"
                                                   TextColor="White"
                                                   LineBreakMode="TailTruncation" />
                                            <Button Text="Chiama"
                                                    BackgroundColor="#2A2A2A"
                                                    TextColor="White"
                                                    Clicked="OnCallContactClicked"
                                                    CommandParameter="{Binding}" />
                                        </VerticalStackLayout>
                                    </Border>

                                    <HorizontalStackLayout HorizontalOptions="End" Spacing="10">
                                        <Label Text="{Binding TimeLabel}"
                                               TextColor="White"
                                               FontSize="10"
                                               Opacity="0.7" />
                                        <Label Text="{Binding StatusLabel}"
                                               IsVisible="{Binding HasStatus}"
                                               TextColor="White"
                                               FontSize="10"
                                               Opacity="0.7" />
                                    </HorizontalStackLayout>

                                </VerticalStackLayout>
                            </Border>

                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Grid IsVisible="{Binding Source={x:Reference ThisPage}, Path=IsLoadingMessages}"
                  BackgroundColor="#00000000">
                <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Spacing="10">
                    <ActivityIndicator IsRunning="True" />
                    <Label Text="Caricamentoâ€¦"
                           TextColor="White"
                           Opacity="0.75" />
                </VerticalStackLayout>
            </Grid>
        </Grid>

        <!-- ROW 2: allegati + emoji -->
        <Grid Grid.Row="2" RowDefinitions="Auto,Auto" RowSpacing="8">
            <Border Grid.Row="0"
                    IsVisible="{Binding Source={x:Reference ThisPage}, Path=HasSelectedAttachments}"
                    StrokeThickness="0"
                    Padding="10"
                    BackgroundColor="#1C1C1C">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="8">
                    <Label Text="Allegati selezionati"
                           TextColor="White"
                           FontAttributes="Bold" />

                    <CollectionView ItemsSource="{Binding Source={x:Reference ThisPage}, Path=AllegatiSelezionati}"
                                    SelectionMode="None"
                                    HeightRequest="130">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8" />
                        </CollectionView.ItemsLayout>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border StrokeThickness="0" Padding="8" BackgroundColor="#2A2A2A">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10" />
                                    </Border.StrokeShape>

                                    <VerticalStackLayout Spacing="4" WidthRequest="240">
                                        <Label Text="{Binding KindLabel}" TextColor="White" FontAttributes="Bold" FontSize="12" />
                                        <Label Text="{Binding DisplayName}" TextColor="White" FontSize="12" LineBreakMode="TailTruncation" />
                                        <Button Text="Rimuovi"
                                                BackgroundColor="#3A3A3A"
                                                TextColor="White"
                                                FontSize="12"
                                                HeightRequest="32"
                                                Clicked="OnRemoveAttachmentClicked"
                                                CommandParameter="{Binding}" />
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>

            <Border Grid.Row="1"
                    IsVisible="{Binding Source={x:Reference ThisPage}, Path=IsEmojiPanelVisible}"
                    StrokeThickness="0"
                    Padding="10"
                    BackgroundColor="#1C1C1C">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>

                <CollectionView ItemsSource="{Binding Source={x:Reference ThisPage}, Path=EmojiItems}"
                                SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" Span="8"
                                         HorizontalItemSpacing="6"
                                         VerticalItemSpacing="6" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Button Text="{Binding .}"
                                    FontSize="18"
                                    BackgroundColor="#2A2A2A"
                                    TextColor="White"
                                    HeightRequest="38"
                                    CornerRadius="10"
                                    Clicked="OnEmojiSelected"
                                    CommandParameter="{Binding .}" />
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Border>
        </Grid>

        <!-- COMPOSER -->
        <Grid Grid.Row="3" ColumnDefinitions="*,Auto" ColumnSpacing="10" VerticalOptions="Center">

            <Border Grid.Column="0"
                    IsVisible="{Binding Source={x:Reference ThisPage}, Path=IsNormalComposerVisible}"
                    StrokeThickness="0"
                    BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=ComposerBarBgColor}"
                    Padding="10,6">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20" />
                </Border.StrokeShape>

                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnComposerTapped" />
                </Border.GestureRecognizers>

                <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10" VerticalOptions="Center">

                    <ImageButton Grid.Column="0"
                                 WidthRequest="28"
                                 HeightRequest="28"
                                 BackgroundColor="#00000000"
                                 Opacity="0.80"
                                 Source="{Binding Source={x:Reference ThisPage}, Path=EmojiButtonIcon}"
                                 Clicked="OnEmojiToggleClicked" />

                    <Entry x:Name="EntryText"
                           Grid.Column="1"
                           Placeholder="Messaggio"
                           PlaceholderColor="#6E6E73"
                           TextColor="White"
                           BackgroundColor="Transparent"
                           Text="{Binding Source={x:Reference ThisPage}, Path=TestoMessaggio}"
                           Focused="OnEntryFocused" />

                    <ImageButton Grid.Column="2"
                                 WidthRequest="28"
                                 HeightRequest="28"
                                 BackgroundColor="#00000000"
                                 Opacity="0.80"
                                 Source="ic_clip.png"
                                 Clicked="OnClipClicked" />

                    <ImageButton Grid.Column="3"
                                 WidthRequest="28"
                                 HeightRequest="28"
                                 BackgroundColor="#00000000"
                                 Opacity="0.80"
                                 Source="ic_camera.png"
                                 Clicked="OnCameraClicked" />
                </Grid>
            </Border>

            <Border Grid.Column="0"
                    IsVisible="{Binding Source={x:Reference ThisPage}, Path=IsVoiceHoldStripVisible}"
                    StrokeThickness="0"
                    BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=ComposerBarBgColor}"
                    Padding="10,6">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20" />
                </Border.StrokeShape>

                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10" VerticalOptions="Center">
                    <Label Grid.Column="0"
                           Text="{Binding Source={x:Reference ThisPage}, Path=VoiceTimeLabel}"
                           TextColor="White"
                           FontAttributes="Bold"
                           VerticalTextAlignment="Center" />

                    <GraphicsView x:Name="VoiceWaveHoldView"
                                  Grid.Column="1"
                                  HeightRequest="24" />
                </Grid>
            </Border>

            <!-- RIGHT: SEND / MIC -->
            <Grid Grid.Column="1" WidthRequest="52" HeightRequest="52" VerticalOptions="Center">

                <Button x:Name="BtnSend"
                        IsVisible="{Binding Source={x:Reference ThisPage}, Path=CanSendTextOrAttachments}"
                        BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=AccentGreenColor}"
                        CornerRadius="26"
                        WidthRequest="52"
                        HeightRequest="52"
                        ImageSource="ic_send.png"
                        Clicked="OnInviaClicked" />

                <!-- MODIFICATO: niente Pressed/Released e niente PanGestureRecognizer -->
                <Button x:Name="BtnMic"
                        IsVisible="{Binding Source={x:Reference ThisPage}, Path=CanShowMic}"
                        BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=AccentGreenColor}"
                        CornerRadius="26"
                        WidthRequest="52"
                        HeightRequest="52"
                        ImageSource="ic_mic.png" />

            </Grid>
        </Grid>

        <!-- LOCK PANEL VOCALE -->
        <Grid Grid.Row="0"
              Grid.RowSpan="4"
              IsVisible="{Binding Source={x:Reference ThisPage}, Path=IsVoiceLockPanelVisible}"
              BackgroundColor="#00000000"
              ZIndex="999">

            <Border VerticalOptions="End"
                    HeightRequest="{Binding Source={x:Reference ThisPage}, Path=VoiceLockPanelHeight}"
                    StrokeThickness="0"
                    BackgroundColor="#111111"
                    Padding="18">

                <Grid RowDefinitions="Auto,Auto" RowSpacing="14">

                    <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                        <Label Grid.Column="0"
                               Text="{Binding Source={x:Reference ThisPage}, Path=VoiceTimeLabel}"
                               TextColor="White"
                               FontSize="34"
                               FontAttributes="Bold"
                               VerticalTextAlignment="Center" />

                        <GraphicsView x:Name="VoiceWaveLockView"
                                      Grid.Column="1"
                                      HeightRequest="36"
                                      VerticalOptions="Center" />

                        <Label Grid.Column="2"
                               Text="1Ã—"
                               TextColor="#9A9A9A"
                               FontSize="18"
                               VerticalTextAlignment="Center"
                               HorizontalTextAlignment="End" />
                    </Grid>

                    <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12" VerticalOptions="End">

                        <ImageButton Grid.Column="0"
                                     WidthRequest="44"
                                     HeightRequest="44"
                                     BackgroundColor="#00000000"
                                     Opacity="0.95"
                                     Source="ic_trash.png"
                                     Clicked="OnVoiceTrashClicked" />

                        <Button Grid.Column="1"
                                Text="{Binding Source={x:Reference ThisPage}, Path=VoicePauseResumeLabel}"
                                FontSize="24"
                                FontAttributes="Bold"
                                TextColor="#FF3B30"
                                BackgroundColor="Transparent"
                                Clicked="OnVoicePauseResumeClicked"
                                HorizontalOptions="Center"
                                VerticalOptions="Center" />

                        <Button Grid.Column="2"
                                BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=AccentGreenColor}"
                                WidthRequest="72"
                                HeightRequest="72"
                                CornerRadius="36"
                                ImageSource="ic_send.png"
                                Clicked="OnVoiceSendClicked" />
                    </Grid>

                </Grid>
            </Border>
        </Grid>

    </Grid>
</ContentPage>
