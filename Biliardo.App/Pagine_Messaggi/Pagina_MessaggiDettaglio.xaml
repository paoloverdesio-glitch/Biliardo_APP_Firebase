<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Biliardo.App.Pagine_Messaggi.Pagina_MessaggiDettaglio"
    x:Name="ThisPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:composer="clr-namespace:Biliardo.App.Componenti_UI.Composer"
    xmlns:ui="clr-namespace:Biliardo.App.Componenti_UI"
    Title="Chat"
    BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=PageBgColor}">

    <Grid RowDefinitions="Auto,*,Auto"
          Padding="10"
          RowSpacing="8">

        <!-- HEADER -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*" ColumnSpacing="10"
              BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=TopBarBgColor}"
              Padding="6">

            <Button Text="â†"
                    WidthRequest="44"
                    HeightRequest="44"
                    BackgroundColor="#00000000"
                    TextColor="White"
                    Clicked="OnBackClicked" />

            <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                <Label Text="{Binding Source={x:Reference ThisPage}, Path=TitoloChat}"
                       TextColor="White"
                       FontAttributes="Bold"
                       FontSize="18"
                       LineBreakMode="TailTruncation" />
                <Label Text="{Binding Source={x:Reference ThisPage}, Path=DisplayNomeCompleto}"
                       IsVisible="{Binding Source={x:Reference ThisPage}, Path=HasDisplayNomeCompleto}"
                       TextColor="White"
                       FontSize="12"
                       Opacity="0.75"
                       LineBreakMode="TailTruncation" />
            </VerticalStackLayout>
        </Grid>

        <!-- AREA MESSAGGI + LOADING -->
        <Grid Grid.Row="1">
            <CollectionView x:Name="CvMessaggi"
                            ItemsSource="{Binding Source={x:Reference ThisPage}, Path=Messaggi}"
                            SelectionMode="None"
                            ItemsUpdatingScrollMode="KeepScrollOffset"
                            ItemSizingStrategy="MeasureFirstItem"
                            Scrolled="OnMessagesScrolled">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="6" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="0,2">

                            <Border x:Name="DateSep"
                                    IsVisible="False"
                                    HorizontalOptions="Center"
                                    BackgroundColor="#1E1E1E"
                                    StrokeThickness="0"
                                    Padding="10,6">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>

                                <Label Text="{Binding DateSeparatorText}"
                                       TextColor="White"
                                       FontSize="12"
                                       Opacity="0.85" />

                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsDateSeparator}" Value="True">
                                        <Setter Property="IsVisible" Value="True" />
                                    </DataTrigger>
                                </Border.Triggers>
                            </Border>

                            <Border x:Name="Bubble"
                                    IsVisible="True"
                                    StrokeThickness="0"
                                    Padding="10"
                                    BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=BubblePeerColor}"
                                    HorizontalOptions="Start"
                                    MaximumWidthRequest="{Binding Source={x:Reference ThisPage}, Path=BubbleMaxWidth}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnMessageActionTapped" />
                                </Border.GestureRecognizers>
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="14" />
                                </Border.StrokeShape>

                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsDateSeparator}" Value="True">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>

                                    <DataTrigger TargetType="Border" Binding="{Binding IsMine}" Value="True">
                                        <Setter Property="HorizontalOptions" Value="End" />
                                        <Setter Property="BackgroundColor" Value="{Binding Source={x:Reference ThisPage}, Path=BubbleMineColor}" />
                                    </DataTrigger>

                                    <DataTrigger TargetType="Border" Binding="{Binding IsHiddenForMe}" Value="True">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                </Border.Triggers>

                                <VerticalStackLayout Spacing="8">

                                    <Label Text="Questo messaggio Ã¨ stato eliminato"
                                           IsVisible="{Binding IsDeletedPlaceholder}"
                                           TextColor="{Binding Source={x:Reference ThisPage}, Path=BubbleTextColor}"
                                           FontAttributes="Italic"
                                           FontSize="12" />

                                    <Label Text="{Binding Text}"
                                           IsVisible="{Binding HasText}"
                                           TextColor="{Binding Source={x:Reference ThisPage}, Path=BubbleTextColor}"
                                           FontSize="14"
                                           LineBreakMode="WordWrap" />

                                    <Border IsVisible="{Binding IsPhoto}"
                                            StrokeThickness="0"
                                            Padding="0"
                                            BackgroundColor="#222222">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>

                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnPhotoTapped" />
                                        </Border.GestureRecognizers>

                                        <Image Source="{Binding MediaLocalPath}"
                                               HeightRequest="170"
                                               Aspect="AspectFill" />
                                    </Border>

                                    <Border IsVisible="{Binding IsFileOrVideo}"
                                            StrokeThickness="0"
                                            Padding="10"
                                            BackgroundColor="#1C1C1C">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>

                                        <VerticalStackLayout Spacing="6">
                                            <Label Text="{Binding FileLabel}"
                                                   TextColor="White"
                                                   FontAttributes="Bold"
                                                   LineBreakMode="TailTruncation" />
                                            <Button Text="Apri"
                                                    BackgroundColor="#2A2A2A"
                                                    TextColor="White"
                                                    Clicked="OnOpenMediaClicked"
                                                    CommandParameter="{Binding}" />
                                        </VerticalStackLayout>
                                    </Border>

                                    <Border IsVisible="{Binding IsAudio}"
                                            StrokeThickness="0"
                                            Padding="10"
                                            BackgroundColor="#1C1C1C">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>

                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                            <Button Text="{Binding AudioPlayStopLabel}"
                                                    BackgroundColor="#2A2A2A"
                                                    TextColor="White"
                                                    Clicked="OnPlayAudioClicked"
                                                    CommandParameter="{Binding}"
                                                    WidthRequest="90"
                                                    HeightRequest="40" />
                                            <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                <Label Text="{Binding AudioLabel}"
                                                       TextColor="White"
                                                       LineBreakMode="TailTruncation" />
                                                <Label Text="{Binding DurationLabel}"
                                                       TextColor="White"
                                                       FontSize="12"
                                                       Opacity="0.7" />
                                            </VerticalStackLayout>
                                        </Grid>
                                    </Border>

                                    <ui:LocationPreviewView IsVisible="{Binding IsLocation}"
                                                            Latitude="{Binding Latitude}"
                                                            Longitude="{Binding Longitude}"
                                                            Address="{Binding LocationLabel}" />

                                    <Border IsVisible="{Binding IsContact}"
                                            StrokeThickness="0"
                                            Padding="10"
                                            BackgroundColor="#1C1C1C">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>
                                        <VerticalStackLayout Spacing="6">
                                            <Label Text="ðŸ‘¤ Contatto"
                                                   TextColor="White"
                                                   FontAttributes="Bold" />
                                            <Label Text="{Binding ContactLabel}"
                                                   TextColor="White"
                                                   LineBreakMode="TailTruncation" />
                                            <Button Text="Chiama"
                                                    BackgroundColor="#2A2A2A"
                                                    TextColor="White"
                                                    Clicked="OnCallContactClicked"
                                                    CommandParameter="{Binding}" />
                                        </VerticalStackLayout>
                                    </Border>

                                    <HorizontalStackLayout HorizontalOptions="End" Spacing="10">
                                        <Label Text="{Binding TimeLabel}"
                                               TextColor="White"
                                               FontSize="10"
                                               Opacity="0.7" />
                                        <Label Text="{Binding StatusLabel}"
                                               IsVisible="{Binding HasStatus}"
                                               TextColor="White"
                                               FontSize="10"
                                               Opacity="0.7" />
                                    </HorizontalStackLayout>

                                </VerticalStackLayout>
                            </Border>

                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Grid IsVisible="{Binding Source={x:Reference ThisPage}, Path=IsLoadingMessages}"
                  BackgroundColor="#00000000">
                <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Spacing="10">
                    <ActivityIndicator IsRunning="True" />
                    <Label Text="Caricamentoâ€¦"
                           TextColor="White"
                           Opacity="0.75" />
                </VerticalStackLayout>
            </Grid>
        </Grid>

        <!-- COMPOSER -->
        <composer:ComposerBarView Grid.Row="2"
                                  x:Name="ComposerBar"
                                  SendRequested="OnComposerSendRequested"
                                  PendingItemSendRequested="OnComposerPendingItemSendRequested"
                                  PendingItemRemoved="OnComposerPendingItemRemoved"
                                  AttachmentActionRequested="OnComposerAttachmentRequested" />

        <!-- Placeholder per compatibilitÃ  legacy -->
        <ContentView IsVisible="False">
            <VerticalStackLayout>
                <Entry x:Name="EntryText" />
                <GraphicsView x:Name="VoiceWaveHoldView" />
                <GraphicsView x:Name="VoiceWaveLockView" />
            </VerticalStackLayout>
        </ContentView>

    </Grid>
</ContentPage>
