<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Biliardo.App.Pagine_Messaggi.Pagina_MessaggiDettaglio"
    x:Name="ThisPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:composer="clr-namespace:Biliardo.App.Componenti_UI.Composer"
    xmlns:ui="clr-namespace:Biliardo.App.Componenti_UI"
    Title="Chat"
    BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=PageBgColor}">

    <Grid RowDefinitions="Auto,*,Auto"
          Padding="10"
          RowSpacing="8">

        <!-- HEADER -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*" ColumnSpacing="10"
              BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=TopBarBgColor}"
              Padding="6">

            <Button Text="â†"
                    WidthRequest="44"
                    HeightRequest="44"
                    BackgroundColor="#00000000"
                    TextColor="White"
                    Clicked="OnBackClicked" />

            <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                <Label Text="{Binding Source={x:Reference ThisPage}, Path=TitoloChat}"
                       TextColor="White"
                       FontAttributes="Bold"
                       FontSize="18"
                       LineBreakMode="TailTruncation" />
                <Label Text="{Binding Source={x:Reference ThisPage}, Path=DisplayNomeCompleto}"
                       IsVisible="{Binding Source={x:Reference ThisPage}, Path=HasDisplayNomeCompleto}"
                       TextColor="White"
                       FontSize="12"
                       Opacity="0.75"
                       LineBreakMode="TailTruncation" />
            </VerticalStackLayout>
        </Grid>

        <!-- AREA MESSAGGI + LOADING -->
        <Grid Grid.Row="1">
            <CollectionView x:Name="CvMessaggi"
                            ItemsSource="{Binding Source={x:Reference ThisPage}, Path=Messaggi}"
                            SelectionMode="None"
                            ItemsUpdatingScrollMode="KeepScrollOffset"
                            ItemSizingStrategy="MeasureAllItems"
                            Scrolled="OnMessagesScrolled">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="6" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="0,2">

                            <!-- Separatore data -->
                            <Border x:Name="DateSep"
                                    IsVisible="False"
                                    HorizontalOptions="Center"
                                    BackgroundColor="#1E1E1E"
                                    StrokeThickness="0"
                                    Padding="10,6">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>

                                <Label Text="{Binding DateSeparatorText}"
                                       TextColor="White"
                                       FontSize="12"
                                       Opacity="0.85" />

                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsDateSeparator}" Value="True">
                                        <Setter Property="IsVisible" Value="True" />
                                    </DataTrigger>
                                </Border.Triggers>
                            </Border>

                            <!-- Bolla messaggio -->
                            <Border x:Name="Bubble"
                                    IsVisible="True"
                                    StrokeThickness="0"
                                    Padding="0"
                                    BackgroundColor="{Binding Source={x:Reference ThisPage}, Path=BubblePeerColor}"
                                    HorizontalOptions="Start"
                                    MaximumWidthRequest="{Binding Source={x:Reference ThisPage}, Path=BubbleMaxWidth}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnMessageActionTapped" />
                                </Border.GestureRecognizers>
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="14" />
                                </Border.StrokeShape>

                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsDateSeparator}" Value="True">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>

                                    <DataTrigger TargetType="Border" Binding="{Binding IsMine}" Value="True">
                                        <Setter Property="HorizontalOptions" Value="End" />
                                        <Setter Property="BackgroundColor" Value="{Binding Source={x:Reference ThisPage}, Path=BubbleMineColor}" />
                                    </DataTrigger>

                                    <DataTrigger TargetType="Border" Binding="{Binding IsHiddenForMe}" Value="True">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                </Border.Triggers>

                                <!-- Layout WhatsApp-like: contenuto + meta (ora/spunte) con gap minimo -->
                                <Grid Padding="10,8,10,6"
                                      RowDefinitions="Auto,Auto"
                                      RowSpacing="2"
                                      HorizontalOptions="Start">

                                    <!-- Contenuto -->
                                    <VerticalStackLayout Grid.Row="0"
                                                        Spacing="6"
                                                        HorizontalOptions="Start">

                                        <Label Text="Questo messaggio Ã¨ stato eliminato"
                                               IsVisible="{Binding IsDeletedPlaceholder}"
                                               TextColor="{Binding Source={x:Reference ThisPage}, Path=BubbleTextColor}"
                                               FontAttributes="Italic"
                                               FontSize="12"
                                               HorizontalOptions="Start" />

                                        <!-- Testo -->
                                        <Label Text="{Binding Text}"
                                               IsVisible="{Binding HasText}"
                                               TextColor="{Binding Source={x:Reference ThisPage}, Path=BubbleTextColor}"
                                               FontSize="14"
                                               LineBreakMode="WordWrap"
                                               MaximumWidthRequest="{Binding Source={x:Reference ThisPage}, Path=BubbleMaxWidth}"
                                               HorizontalOptions="Start" />

                                        <!-- FOTO -->
                                        <Border IsVisible="{Binding IsPhoto}"
                                                StrokeThickness="0"
                                                Padding="0"
                                                BackgroundColor="#222222"
                                                HorizontalOptions="Start"
                                                WidthRequest="{Binding Source={x:Reference ThisPage}, Path=MediaPreviewWidth}"
                                                HeightRequest="{Binding Source={x:Reference ThisPage}, Path=MediaPreviewHeight}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnPhotoTapped" />
                                            </Border.GestureRecognizers>

                                            <Image Source="{Binding MediaLocalPath}"
                                                   Aspect="AspectFill" />
                                        </Border>

                                        <!-- VIDEO: anteprima (primo frame) + play + durata -->
                                        <Border IsVisible="{Binding IsVideo}"
                                                StrokeThickness="0"
                                                Padding="0"
                                                BackgroundColor="#222222"
                                                HorizontalOptions="Start"
                                                WidthRequest="{Binding Source={x:Reference ThisPage}, Path=MediaPreviewWidth}"
                                                HeightRequest="{Binding Source={x:Reference ThisPage}, Path=MediaPreviewHeight}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnOpenMediaTapped" />
                                            </Border.GestureRecognizers>

                                            <Grid>
                                                <!-- Thumbnail: se non ancora pronto rimane il fondo scuro + play -->
                                                <Image Source="{Binding VideoThumbnailPath}"
                                                       IsVisible="{Binding HasVideoThumbnail}"
                                                       Aspect="AspectFill" />

                                                <!-- Play overlay -->
                                                <Border BackgroundColor="#66000000"
                                                        StrokeThickness="0"
                                                        HorizontalOptions="Center"
                                                        VerticalOptions="Center"
                                                        Padding="10">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="24" />
                                                    </Border.StrokeShape>
                                                    <Label Text="â–¶"
                                                           TextColor="White"
                                                           FontSize="20"
                                                           VerticalOptions="Center"
                                                           HorizontalOptions="Center" />
                                                </Border>

                                                <!-- Durata -->
                                                <Border BackgroundColor="#66000000"
                                                        StrokeThickness="0"
                                                        HorizontalOptions="End"
                                                        VerticalOptions="End"
                                                        Margin="8"
                                                        Padding="6,2">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="10" />
                                                    </Border.StrokeShape>
                                                    <Label Text="{Binding DurationLabel}"
                                                           TextColor="White"
                                                           FontSize="10"
                                                           Opacity="0.9" />
                                                </Border>
                                            </Grid>
                                        </Border>

                                        <!-- DOCUMENTO / FILE -->
                                        <Border IsVisible="{Binding IsFile}"
                                                StrokeThickness="0"
                                                Padding="10"
                                                BackgroundColor="#1C1C1C"
                                                HorizontalOptions="Start"
                                                MaximumWidthRequest="{Binding Source={x:Reference ThisPage}, Path=BubbleMaxWidth}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnOpenMediaTapped" />
                                            </Border.GestureRecognizers>

                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                                                <Label Text="ðŸ“Ž"
                                                       FontSize="18"
                                                       TextColor="White"
                                                       VerticalOptions="Center" />

                                                <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                    <Label Text="{Binding FileName}"
                                                           TextColor="White"
                                                           FontAttributes="Bold"
                                                           LineBreakMode="TailTruncation" />
                                                    <Label Text="{Binding FileSizeLabel}"
                                                           TextColor="White"
                                                           FontSize="11"
                                                           Opacity="0.75"
                                                           LineBreakMode="TailTruncation" />
                                                </VerticalStackLayout>

                                                <Label Grid.Column="2"
                                                       Text="Apri"
                                                       TextColor="White"
                                                       Opacity="0.85"
                                                       VerticalOptions="Center" />
                                            </Grid>
                                        </Border>

                                        <!-- AUDIO -->
                                        <Border IsVisible="{Binding IsAudio}"
                                                StrokeThickness="0"
                                                Padding="10"
                                                BackgroundColor="#1C1C1C"
                                                HorizontalOptions="Start"
                                                MaximumWidthRequest="{Binding Source={x:Reference ThisPage}, Path=BubbleMaxWidth}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>

                                            <Grid ColumnDefinitions="Auto,Auto" ColumnSpacing="10">
                                                <Button Text="{Binding AudioPlayStopLabel}"
                                                        BackgroundColor="#2A2A2A"
                                                        TextColor="White"
                                                        Clicked="OnPlayAudioClicked"
                                                        CommandParameter="{Binding}"
                                                        WidthRequest="90"
                                                        HeightRequest="40" />
                                                <VerticalStackLayout Grid.Column="1" Spacing="2" HorizontalOptions="Start">
                                                    <Label Text="{Binding AudioLabel}"
                                                           TextColor="White"
                                                           LineBreakMode="TailTruncation" />
                                                    <Label Text="{Binding DurationLabel}"
                                                           TextColor="White"
                                                           FontSize="12"
                                                           Opacity="0.7" />
                                                </VerticalStackLayout>
                                            </Grid>
                                        </Border>

                                        <!-- LOCATION -->
                                        <ui:LocationPreviewView IsVisible="{Binding IsLocation}"
                                                                Latitude="{Binding Latitude}"
                                                                Longitude="{Binding Longitude}"
                                                                Address="{Binding LocationLabel}"
                                                                HorizontalOptions="Start"
                                                                MaximumWidthRequest="{Binding Source={x:Reference ThisPage}, Path=BubbleMaxWidth}" />

                                        <!-- CONTATTO -->
                                        <Border IsVisible="{Binding IsContact}"
                                                StrokeThickness="0"
                                                Padding="10"
                                                BackgroundColor="#1C1C1C"
                                                HorizontalOptions="Start"
                                                MaximumWidthRequest="{Binding Source={x:Reference ThisPage}, Path=BubbleMaxWidth}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>

                                            <VerticalStackLayout Spacing="4">
                                                <Label Text="ðŸ‘¤ Contatto"
                                                       TextColor="White"
                                                       FontAttributes="Bold" />
                                                <Label Text="{Binding ContactLabel}"
                                                       TextColor="White"
                                                       LineBreakMode="TailTruncation" />
                                                <Button Text="Chiama"
                                                        BackgroundColor="#2A2A2A"
                                                        TextColor="White"
                                                        Clicked="OnCallContactClicked"
                                                        CommandParameter="{Binding}" />
                                            </VerticalStackLayout>
                                        </Border>

                                    </VerticalStackLayout>

                                    <!-- Meta: ora + spunte (gap minimo, sempre vicino al contenuto) -->
                                    <HorizontalStackLayout Grid.Row="1"
                                                          HorizontalOptions="End"
                                                          Spacing="8">
                                        <Label Text="{Binding TimeLabel}"
                                               TextColor="White"
                                               FontSize="10"
                                               Opacity="0.7" />
                                        <Label Text="{Binding StatusLabel}"
                                               IsVisible="{Binding HasStatus}"
                                               TextColor="White"
                                               FontSize="10"
                                               Opacity="0.7" />
                                    </HorizontalStackLayout>

                                </Grid>
                            </Border>

                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Grid IsVisible="{Binding Source={x:Reference ThisPage}, Path=IsLoadingMessages}"
                  BackgroundColor="#00000000">
                <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Spacing="10">
                    <ActivityIndicator IsRunning="True" />
                    <Label Text="Caricamentoâ€¦"
                           TextColor="White"
                           Opacity="0.75" />
                </VerticalStackLayout>
            </Grid>
        </Grid>

        <!-- COMPOSER -->
        <composer:ComposerBarView Grid.Row="2"
                                  x:Name="ComposerBar"
                                  SendRequested="OnComposerSendRequested"
                                  PendingItemSendRequested="OnComposerPendingItemSendRequested"
                                  PendingItemRemoved="OnComposerPendingItemRemoved"
                                  AttachmentActionRequested="OnComposerAttachmentRequested" />

        <!-- Placeholder per compatibilitÃ  legacy -->
        <ContentView IsVisible="False">
            <VerticalStackLayout>
                <Entry x:Name="EntryText" />
                <GraphicsView x:Name="VoiceWaveHoldView" />
                <GraphicsView x:Name="VoiceWaveLockView" />
            </VerticalStackLayout>
        </ContentView>

    </Grid>
</ContentPage>
