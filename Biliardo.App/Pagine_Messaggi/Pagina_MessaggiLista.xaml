<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Biliardo.App.Pagine_Messaggi.Pagina_MessaggiLista"
    x:Name="ThisPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:ui="clr-namespace:Biliardo.App.Componenti_UI"
    xmlns:dbg="clr-namespace:Biliardo.App.RiquadroDebugTrasferimentiFirebase"
    Title="Messaggi"
    BackgroundColor="#0B0B0B">

    <Grid RowDefinitions="Auto,*" Padding="12,8" BackgroundColor="#0B0B0B">
        <dbg:TransferDebugPanelView Grid.Row="0"
                                    Margin="0,0,0,6"
                                    HorizontalOptions="Fill" />

        <VerticalStackLayout Grid.Row="1" Spacing="8">
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                <Button Text="Nuova chat"
                        Grid.Column="0"
                        Clicked="OnNuovaChat" />
                <Button Grid.Column="1"
                        Text="ðŸ—‘"
                        IsVisible="{Binding Source={x:Reference ThisPage}, Path=HasChatSelection}"
                        BackgroundColor="#222222"
                        TextColor="White"
                        Clicked="OnDeleteSelectedChats" />
            </Grid>

            <ui:SelettoreUtenteAutocomplete
                x:Name="UserPicker"
                MinChars="1"
                PageTake="100"
                MaxVisible="10"
                IsVisible="False" />

            <ActivityIndicator IsVisible="{Binding IsLoading}"
                               IsRunning="{Binding IsLoading}"
                               Color="White"
                               HorizontalOptions="Center" />

            <CollectionView x:Name="ListaChat"
                            ItemsSource="{Binding ChatPreviews}"
                            SelectionMode="None"
                            BackgroundColor="#0B0B0B"
                            ItemsUpdatingScrollMode="KeepScrollOffset"
                            ItemSizingStrategy="MeasureFirstItem">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="8,6"
                              HorizontalOptions="Fill"
                              Loaded="OnChatRowLoaded"
                              Unloaded="OnChatRowUnloaded">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <Grid Grid.Column="0" WidthRequest="{x:Static ui:UserAvatarView.DefaultSize}">
                                <ui:UserAvatarView AvatarUrl="{Binding AvatarUrl}"
                                                   AvatarPath="{Binding AvatarPath}"
                                                   DisplayName="{Binding Nickname}"
                                                   VerticalOptions="Center" />
                                <Border IsVisible="{Binding IsSelected}"
                                        BackgroundColor="#25D366"
                                        StrokeThickness="0"
                                        WidthRequest="14"
                                        HeightRequest="14"
                                        HorizontalOptions="End"
                                        VerticalOptions="End"
                                        Margin="0,0,-2,-2">
                                    <Border.StrokeShape>
                                        <Ellipse />
                                    </Border.StrokeShape>
                                    <Label Text="âœ“"
                                           FontSize="10"
                                           TextColor="Black"
                                           HorizontalTextAlignment="Center"
                                           VerticalTextAlignment="Center" />
                                </Border>
                            </Grid>

                            <VerticalStackLayout Grid.Column="1" Spacing="2" Padding="10,0">
                                <HorizontalStackLayout Spacing="6">
                                    <Label Text="{Binding Nickname}"
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           LineBreakMode="TailTruncation" />
                                    <Label Text="{Binding FullNameDisplay}"
                                           FontSize="12"
                                           TextColor="White"
                                           LineBreakMode="TailTruncation"
                                           IsVisible="{Binding HasFullName}" />
                                </HorizontalStackLayout>
                                <Label Text="{Binding PreviewText}"
                                       FontSize="12"
                                       TextColor="#B0B0B0"
                                       LineBreakMode="TailTruncation">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsTyping}" Value="True">
                                            <Setter Property="TextColor" Value="#25D366" />
                                            <Setter Property="FontAttributes" Value="Italic" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="2"
                                                 Spacing="4"
                                                 HorizontalOptions="End"
                                                 VerticalOptions="Center">
                                <Label Text="{Binding TimeLabel}"
                                       FontSize="11"
                                       TextColor="{Binding TimeColor}"
                                       HorizontalTextAlignment="End" />
                                <Border IsVisible="{Binding UnreadBadgeVisible}"
                                        BackgroundColor="#25D366"
                                        StrokeThickness="0"
                                        Padding="{Binding UnreadBadgePadding}"
                                        MinimumWidthRequest="{Binding UnreadBadgeMinWidth}"
                                        StrokeShape="RoundRectangle 999"
                                        HorizontalOptions="End">
                                    <Label Text="{Binding UnreadBadgeText}"
                                           FontSize="11"
                                           TextColor="Black"
                                           HorizontalTextAlignment="Center"
                                           VerticalTextAlignment="Center" />
                                </Border>
                            </VerticalStackLayout>

                            <Grid.Triggers>
                                <DataTrigger TargetType="Grid" Binding="{Binding IsSelected}" Value="True">
                                    <Setter Property="BackgroundColor" Value="#0D3B1E" />
                                </DataTrigger>
                            </Grid.Triggers>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </Grid>
</ContentPage>
