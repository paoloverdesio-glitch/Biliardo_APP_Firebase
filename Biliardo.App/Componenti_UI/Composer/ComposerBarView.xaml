<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:composer="clr-namespace:Biliardo.App.Componenti_UI.Composer"
             x:Class="Biliardo.App.Componenti_UI.Composer.ComposerBarView"
             x:Name="ThisView">

    <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="8">

        <!-- Pending items -->
        <CollectionView Grid.Row="0"
                        ItemsSource="{Binding PendingItems, Source={x:Reference ThisView}}"
                        SelectionMode="None"
                        Margin="0,0,0,4"
                        IsVisible="{Binding HasPendingItems, Source={x:Reference ThisView}}">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border Padding="10"
                            Stroke="#2B2B2B"
                            BackgroundColor="#151515"
                            StrokeThickness="1"
                            Margin="0,0,0,8">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12" />
                        </Border.StrokeShape>

                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="{Binding DisplayName}"
                                       TextColor="White"
                                       FontAttributes="Bold" />
                                <Label Text="{Binding Kind}"
                                       TextColor="#A5A5A5"
                                       FontSize="12" />
                            </VerticalStackLayout>

                            <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                                <Button Text="{Binding AudioPlayLabel}"
                                        IsVisible="{Binding IsAudioDraft}"
                                        Clicked="OnPlayDraftClicked"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#1E1E1E"
                                        TextColor="White"
                                        CornerRadius="8"
                                        Padding="8,4" />
                                <Button Text="Invia"
                                        Clicked="OnSendDraftClicked"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#18A558"
                                        TextColor="White"
                                        CornerRadius="8"
                                        Padding="8,4" />
                                <Button Text="âœ•"
                                        Clicked="OnRemovePendingClicked"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#2B2B2B"
                                        TextColor="White"
                                        CornerRadius="8"
                                        Padding="6,4" />
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Voice hold strip -->
        <Border Grid.Row="1"
                IsVisible="{Binding IsVoiceHoldStripVisible, Source={x:Reference ThisView}}"
                StrokeThickness="0"
                BackgroundColor="#1C1C1C"
                Padding="10,6">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="16" />
            </Border.StrokeShape>

            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                <Label Text="{Binding VoiceTimeLabel, Source={x:Reference ThisView}}"
                       TextColor="#FF3B30"
                       FontAttributes="Bold"
                       VerticalTextAlignment="Center" />

                <VerticalStackLayout Grid.Column="1" Spacing="4">
                    <GraphicsView x:Name="VoiceWaveHoldView"
                                  HeightRequest="40" />
                    <Label Text="{Binding VoiceHintLabel, Source={x:Reference ThisView}}"
                           TextColor="#A5A5A5"
                           FontSize="12" />
                </VerticalStackLayout>

                <ContentView Grid.Column="2"
                             WidthRequest="46"
                             InputTransparent="True" />
            </Grid>
        </Border>

        <!-- Normal composer -->
        <Border Grid.Row="2"
                IsVisible="{Binding IsComposerSurfaceVisible, Source={x:Reference ThisView}}"
                StrokeThickness="0"
                BackgroundColor="#1C1C1C"
                Padding="10,6">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="20" />
            </Border.StrokeShape>

            <!-- MODIFICA: tolta la 4a colonna.
                 Ora lâ€™area â€œpulsante a destraâ€ Ã¨ UNA SOLA colonna (Grid.Column=2) con un contenitore fisso 46x46.
                 Dentro ci sono sia INVIA che MIC, sovrapposti e centrati: cosÃ¬ hanno IDENTICO centro. -->
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10" VerticalOptions="Center">

                <ImageButton Grid.Column="0"
                             WidthRequest="28"
                             HeightRequest="28"
                             BackgroundColor="#00000000"
                             Opacity="0.9"
                             Source="ic_clip.png"
                             Clicked="OnAttachmentClicked"
                             IsVisible="{Binding IsNormalComposerVisible, Source={x:Reference ThisView}}" />

                <Entry Grid.Column="1"
                       x:Name="ComposerEntry"
                       Placeholder="Scrivi..."
                       PlaceholderColor="#6E6E73"
                       TextColor="White"
                       BackgroundColor="Transparent"
                       Text="{Binding ComposerText, Source={x:Reference ThisView}}"
                       IsVisible="{Binding IsNormalComposerVisible, Source={x:Reference ThisView}}"
                       Focused="OnComposerEntryFocused"
                       Unfocused="OnComposerEntryUnfocused" />

                <!-- Contenitore fisso: garantisce lo stesso punto di ancoraggio a destra -->
                <Grid Grid.Column="2"
                      WidthRequest="46"
                      HeightRequest="46"
                      HorizontalOptions="End"
                      VerticalOptions="Center">

                    <!-- INVIA: cerchio verde + icona piÃ¹ piccola e centrata -->
                    <Border WidthRequest="46"
                            HeightRequest="46"
                            StrokeThickness="0"
                            BackgroundColor="#18A558"
                            HorizontalOptions="Center"
                            VerticalOptions="Center"
                            IsVisible="{Binding CanSend, Source={x:Reference ThisView}}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="23" />
                        </Border.StrokeShape>

                        <ImageButton BackgroundColor="Transparent"
                                     Padding="0"
                                     Aspect="AspectFit"
                                     Source="ic_send.svg"
                                     WidthRequest="22"
                                     HeightRequest="22"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Clicked="OnSendClicked" />
                    </Border>

                    <!-- MIC: stesso identico centro del tasto invia -->
                    <composer:MicHoldButton IsVisible="{Binding IsMicVisible, Source={x:Reference ThisView}}"
                                            WidthRequest="46"
                                            HeightRequest="46"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center"
                                            AccentColor="#18A558"
                                            HoldStarted="OnMicHoldStarted"
                                            HoldMoved="OnMicHoldMoved"
                                            HoldEnded="OnMicHoldEnded"
                                            HoldCanceled="OnMicHoldCanceled" />
                </Grid>
            </Grid>
        </Border>

        <!-- Voice lock panel -->
        <Border Grid.Row="2"
                IsVisible="{Binding IsVoiceLockPanelVisible, Source={x:Reference ThisView}}"
                StrokeThickness="0"
                BackgroundColor="#111111"
                Padding="14">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="16" />
            </Border.StrokeShape>

            <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="10">
                <Label Text="{Binding VoiceTimeLabel, Source={x:Reference ThisView}}"
                       TextColor="#FF3B30"
                       FontSize="20"
                       FontAttributes="Bold" />

                <GraphicsView Grid.Row="1"
                              x:Name="VoiceWaveLockView"
                              HeightRequest="48" />

                <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                    <Button Grid.Column="0"
                            Text="ðŸ—‘"
                            BackgroundColor="#2B2B2B"
                            TextColor="White"
                            CornerRadius="12"
                            Clicked="OnVoiceTrashClicked" />

                    <Button Grid.Column="1"
                            Text="{Binding VoicePauseResumeLabel, Source={x:Reference ThisView}}"
                            BackgroundColor="Transparent"
                            TextColor="#FF3B30"
                            FontAttributes="Bold"
                            Clicked="OnVoicePauseResumeClicked" />

                    <!-- INVIA (lock): cerchio verde + icona piÃ¹ piccola e centrata -->
                    <Border Grid.Column="2"
                            WidthRequest="46"
                            HeightRequest="46"
                            StrokeThickness="0"
                            BackgroundColor="#18A558"
                            HorizontalOptions="End"
                            VerticalOptions="Center">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="23" />
                        </Border.StrokeShape>

                        <ImageButton BackgroundColor="Transparent"
                                     Padding="0"
                                     Aspect="AspectFit"
                                     Source="ic_send.svg"
                                     WidthRequest="22"
                                     HeightRequest="22"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Clicked="OnVoiceDoneClicked" />
                    </Border>
                </Grid>
            </Grid>
        </Border>

    </Grid>
</ContentView>
