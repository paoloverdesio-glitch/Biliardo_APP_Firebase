name: Codex auto-fix on CI failure

on:
  workflow_run:
    workflows: ["build"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-autofix-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  autofix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: windows-latest
    env:
      FAILED_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
      FAILED_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}

    steps:
      - name: Checkout failing commit
        uses: actions/checkout@v5
        with:
          ref: ${{ env.FAILED_HEAD_SHA }}
          fetch-depth: 0

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install MAUI workloads
        run: dotnet workload install maui-windows maui-android

      - name: Restore
        run: dotnet restore Biliardo.App/Biliardo.App.csproj

      - name: Install Codex CLI
        run: npm i -g @openai/codex@latest

      - name: Run Codex (fix build)
        env:
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
        shell: pwsh
        run: |
          $prompt = @'
You are in a .NET MAUI repository.

GOAL
Make CI succeed for BOTH targets with 0 errors:
1) dotnet build Biliardo.App/Biliardo.App.csproj -c Debug -f net8.0-windows10.0.19041.0
2) dotnet build Biliardo.App/Biliardo.App.csproj -c Debug -f net8.0-android

RULES
- Keep changes minimal and strictly related to fixing build errors.
- Do NOT modify generated outputs under **/bin or **/obj.
- Do NOT add secrets or credentials to the repo.
- After each fix, re-run the failing build(s) until BOTH succeed with 0 errors.
- At the end, print a short summary and list of files changed.
'@
          codex exec --full-auto --sandbox workspace-write $prompt

      - name: Verify build (Windows)
        run: dotnet build Biliardo.App/Biliardo.App.csproj -c Debug -f net8.0-windows10.0.19041.0 --no-restore

      - name: Verify build (Android)
        run: dotnet build Biliardo.App/Biliardo.App.csproj -c Debug -f net8.0-android --no-restore

      - name: Create PR with fixes
        uses: peter-evans/create-pull-request@v8
        with:
          base: ${{ env.FAILED_HEAD_BRANCH }}
          branch: codex/autofix-${{ env.FAILED_HEAD_SHA }}
          title: "Codex autofix: make CI pass"
          commit-message: "Codex: autofix CI build failures"
          body: |
            Automated fixes generated by Codex based on the failed CI run.
            - Target branch: ${{ env.FAILED_HEAD_BRANCH }}
            - Failed SHA: ${{ env.FAILED_HEAD_SHA }}
          labels: codex,autofix
